# 提升TSDB 服务端性能的探究
</br>

## 1. 前言： 简述服务端的基本设计
由于了解到MySQL有批处理机制，可以批量的向一张table中一次性插入大量数据，我在设计服务端时，打算利用这一机制来提高服务端对监控数据的存储性能。  


>这一机制在`JDBC`层面是这样实现的：利用生成一个`PreparedStatement`类，持有一个sql模板，然后每次录入新的监控信息时，向该`PreparedStatement`类中添加数据，而非直接向数据库添加，等添加了上千条监控信息以后，再将这些信息一次性批量存入数据库，这样就大大提高了存储性能。  

于是，我使每一个设备（每个cpu和硬盘）都对应了一个`Dao`类，即数据库操纵类，`Dao`类拥关键的有一个`Connection`数据库链接类、一个`PreparedStatemennt`类。
当设备在服务端登录以后，就由一张哈希表把改设备和对应的`Dao`关联起来，设备每次请求存储信息时，服务端通过设备名找到其对应的`Dao`，把信息先录入`PreparedStatement`持有的sql模板当中，直到积累类上千条信息，再把这些信息一次性录入。



## 2. 实验——不借助MySQL批处理：
在这个实验中，我不借助上述的批处理机制，每当设备请求存储信息时，给该设备临时分配一个`Dao`，临时获取到数据库的`Connection`连接，执行一条插入语句后，销毁此`Dao`。
在下一个请求到来时重复以上流程。  

于是，我得到了这样的实验结果:  
**插入2000 条数据，平均花费86.927s。**

<a href="https://github.com/Philosjay/TSDB_demo/tree/test_for_non_Batch"  target="_blank">该实验 github 链接</a>

## 3. 实验——不借助MySQL批处理，但让每一个设备保持一个与数据库的连接：
这是上一个实验的改进版，在上一个实验的基础上，使用哈希表把每一个在服务端登录的设备和它对应的`Dao`关联起来，这个`Dao`持有该设备与数据库的`Connection`连接，于是，设备在后续发出存储请求时，就不需要重新建立连接，直接使用之前建立的连接。  

于是，我得到了这样的实验结果：  
**插入2000 条数据，平均花费72.086s。**

  

可见，建立与数据库的连接的确时一笔开销，保证设备拥有一个与数据库持久的连接可以提高服务端性能。

<a href="https://github.com/Philosjay/TSDB_demo/tree/test_for_non_Batch_AND_static_Connection"  target="_blank">该实验 github 链接</a>

## 4. 实验——借助MySQL批处理：
我通过前言所说的设计方法，使每个设备在请求监控信息存储时，先向各自的`PreparedStatement`中写入，等写入了上千条数据后，再一次性存入数据库。  

于是，我得到了这样的实验结果：  
**插入2000 条数据，平均花费5.392s。**  

这是一个飞跃性的提升，可见，借助MySQL的批处理的确能让服务端更高效地存入数据，使其性能得到大幅提升。

<a href="https://github.com/Philosjay/TSDB_demo/tree/test_for_Batch"  target="_blank">该实验 github 链接</a>

## 5. 实验总结：

可见，在TSDB中，由于同一个设备需要持续地、高频类地向数据库中存入监控数据，所以我们可以利用数据库批处理机制，来极大提升数据写入的效率。   

那么，在进行自己的数据库设计和开发时，应当实现这种批处理机制，如果可能，还可以根据业务需要，对此机制进行改进，使得TSDB服务端获得更高的存储效率。


